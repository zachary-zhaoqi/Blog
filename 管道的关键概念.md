# 管道关键概念

管道是Linux支持的最初UnixIPC形式之一，具有以下特点：管道是半双工的，数据只能向一个方向流动；需要双方通信时，需要建立起两个管道；只能用于父子进程或者兄弟进程之间（具有亲缘关系的进程）；单独构成一种独立的文件系统：管道对于管道两端的进程而言，就是一个文件，但它不是普通的文件，它不属于某种文件系统，而是自立门户，单独构成一种文件系统，并且只存在与内存中。数据的读出和写入：一个进程向管道中写的内容被管道另一端的进程读出。写入的内容每次都添加在管道缓冲区的末尾，并且每次都是从缓冲区的头部读出数据。

## 一、管道的实现机制

管道就是指用于连接一个读进程和一个写进程,以实现它们之间通信的共享文件,又称pipe文件。Linux中实现了两种管道,一种是无名管道,一种是命名管道。无名管道没有磁盘节点,它仅作为一个内存对象存在,用完后就销毁了。因为没有文件名和路径,也没有磁盘节点,因此无名管道没有显式的打开过程,实际上它是在创建时就自动打开的,并且生成内存inode节点、dentry目录项对象和两个文件结构对象(一个读操作、一个写操作),其内存对象和普通文件的一致,所以读写操作使用的是同样的文件接口,当然读写函数是专用的。因为无名管道不能显式打开,因此只能由父子进程之间、兄弟进程之间或者其他有亲缘关系并且都继承了祖先进程的管道文件对象的两个进程间通信使用。命名管道是有文件名和磁盘i节点的,因此可由任意两个或多个进程间通信使用,它的使用方法和普通文件类似,都遵循打开、读、写、关闭这样的过程,但是读写的内部实现和普通文件不同,而和无名管道一样。

## 二、无名管道的工作方式

管道以先进先出方式保存一定数量的数据。使用管道的时候一个进程从管道的一端写,另一个进程从管道的另一端读。在主进程中利用fork()函数创建一个子进程,这样父子进程同时拥有对同一管道的读写句柄,因为管道没有提供锁定的保护机制,所以必须决定数据的流动方向,然后在相应进程中关闭不需要的句柄。这样,就可以使用read()和write()函数来对它进行读写操作了。

使用无名管道进行进程间通信的步骤概述如下:

   1. 创建所需的管道;
   1. 生成(多个)子进程;
   1. 关闭/复制文件描述符,使之与相应的管道末端相联系;
   1. 关闭不需要的管道末端;
   1. 进行通信活动;
   1. 关闭所有剩余的打开文件描述符
   1. 等待子进程结束。

由于read()函数和write()函数对管道操作自身带有阻塞作用,能够保证一个进程必须先进行写操作,然后另外的进程才能进行读操作,从而实现父子进程的同步。

### 无名管道的建立和使用

   1. 管道的创建pipe函数  
   `#include<unistd.h>intpipe(intfd[2])`  
   函数的参数中有两个文件描述符:fd[0]用于管道的read端,fd[1]用于管道的write端。创建成功则返回值0,否则返回-1值。

   1. 写管道write函数  
   `ret=write(fd[1],buf,n)`  
   若管道已满,则被阻塞,直到管道另一端read将已进人管道的数据取走为止。

   1. 读管道read函数  
   `ret=read(fd[0],buf,n)`  
   若管道为空,且写端文件描述字未关闭,则被阻塞。若管道写端已关闭,则返回0。若管道不为空,分两种情况:(设管道中实际有m个字节),如n>=m,则读m个;如果n<m则读取n个。实际读取的数目作为read的返回值。

   1. 关闭管道close函数  
   关闭写端则导致读端read调用返回0;关闭读端,则导致写端write调用返回-1,errno被设为EPIPE,在写端write函数退出前,进程还会收到SIGPIPE信号(默认处理是终止进程,该信号可以被捕捉)。

   1. 文件描述符的复制dup2  
   `intdup2(intfdl,intfd2);`  
   复制文件描述符fdl到fd2。fd2可以是空闲的文件描述符,如果fd2是已打开文件,则关闭fd2;如果fd1不是有效的描述符,则不关闭fd2,调用失败。

### 关于无名管道需要注意的几个问题

- 管道是半双工方式,数据只能单向传输。如果要在两个进程之间相互传送数据,就要建立两条管道。
- pipe()调用必须在调用fork()以前进行,否则子进程将无法继承文件描述符。
- 使用无名管道互相连接的任意进程必须位于一个相关的进程家族里。因为管道必须受到内核的限制,所以如果进程没有在管道创建者的家族里面,则该进程将无法访问管道。

## 三、命名管道

在Linux系统中,可以识别命名管道文件。  
例如:  
`$ls-lfilenameprw-r--r--lrootroot0sep2719:40filename|filename`  
文件名后跟着一个“|”符号表明该文件是管道文件。

### 命名管道的工作方式

无名管道应用的一个重大限制是只能用于具有亲缘关系的进程间通信,在命名管道提出后,该限制得到了克服。  
命名管道提供一个路径名与之关联,以FIFO的文件形式存在于文件系统中。  
这样,即使与FIFO的创建进程不存在亲缘关系的进程,只要可以访问该路径,就能够彼此通过FIFO相互通信。因此,通过FIFO,不相关的进程也能交换数据。  
FIFO管道的打开方式与普通管道有所不同,普通管道包括两个文件数据结构:对应的VFS索引节点以及共享数据页,在进程每次运行时都会创建一次,而FIFO是一直存在的,需要用户打开和关闭。  
Linux必须处理读进程先于写进程打开管道、读进程在写进程写入数据之前读入这两种情况。  
除此之外,FIFO管道的使用方式与普通管道完全相同,都使用相同的数据结构和操作。

### FIFO文件的创建

命名管道的创建有两种常见的方法:在shell提示符下使用mknod命令或在程序中使用mknod()系统调用。

#### shell命令行方式

`$mknodfilenamep`  
`$mkfifoa=rwfilename`  
这两个命令行均可创建FIFO文件filename。  
mkfifo提供了直接改变文件读写权限的功能。mknod创建的文件通过chmod可以改变权限。其中参数p表示所建立的节点,即特殊文件的类型为命名管道。

### 管道的不足

管道提供了从一种进程向另一种进程传输数据的有效方法,但是,管道还是存在一些不足:

- 因为读数据的同时也将数据从管道移去,因此管道不能用来对多个接受者广播数据。
- 如果一个管道有多个读进程,那么写进程不能发送数据到指定的读进程。同样,如果有多个写进程,那么没有方法来判别是它们中的哪一个发送的数据。